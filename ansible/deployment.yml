# deployment.yml
---
- hosts: all
  gather_facts: "no"

  tasks:

      - name: run "apt-get update"
        apt:
            update_cache: "yes"

      - name: update all packages to the latest
        apt:
            upgrade: dist

      - name: install "snapd" package
        apt:
            package: snapd
            state: present

      - name: install latest stable "microk8s" snap
        snap:
            name: microk8s
            channel: latest
            classic: "yes"
            state: present
        notify:
            - enable snapd
            - restart snapd
            - enable microk8s
            - create alias k
            - create alias kubectl
            - create alias helm
            - reboot

  handlers:

      - name: enable snapd
        service:
            name: snapd
            enabled: "yes"

      - name: restart snapd
        service:
            name: snapd
            state: restarted

      - name: enable microk8s
        command: /snap/bin/microk8s.enable dns storage ingress helm3

      - name: create alias k
        command: snap alias microk8s.kubectl k

      - name: create alias kubectl
        command: snap alias microk8s.kubectl kubectl

      - name: create alias helm
        command: snap alias microk8s.helm3 helm

      - name: reboot
        reboot:
            reboot_timeout: 120
